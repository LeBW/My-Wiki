<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>同源政策与跨域 | LBW&#39;s Wiki Pages</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/lbw-wiki.png">
    <meta name="description" content="Organize all of my knowledge.">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.6eab1976.js" as="script"><link rel="preload" href="/assets/js/2.167d90c7.js" as="script"><link rel="preload" href="/assets/js/54.83caae44.js" as="script"><link rel="prefetch" href="/assets/js/10.1ec14536.js"><link rel="prefetch" href="/assets/js/100.d3be4e1b.js"><link rel="prefetch" href="/assets/js/101.971eb1f4.js"><link rel="prefetch" href="/assets/js/102.2ae2fa3b.js"><link rel="prefetch" href="/assets/js/11.ec909d32.js"><link rel="prefetch" href="/assets/js/12.75d6c1db.js"><link rel="prefetch" href="/assets/js/13.fafebc4f.js"><link rel="prefetch" href="/assets/js/14.7da14f0a.js"><link rel="prefetch" href="/assets/js/15.0e8dd2a9.js"><link rel="prefetch" href="/assets/js/16.d9b44fc4.js"><link rel="prefetch" href="/assets/js/17.7a43f1b2.js"><link rel="prefetch" href="/assets/js/18.c16ff94e.js"><link rel="prefetch" href="/assets/js/19.4052930d.js"><link rel="prefetch" href="/assets/js/20.c97d4e30.js"><link rel="prefetch" href="/assets/js/21.fec0ccc6.js"><link rel="prefetch" href="/assets/js/22.b13a8b79.js"><link rel="prefetch" href="/assets/js/23.60db8c03.js"><link rel="prefetch" href="/assets/js/24.0eb76eee.js"><link rel="prefetch" href="/assets/js/25.9bbc378a.js"><link rel="prefetch" href="/assets/js/26.d71f4e99.js"><link rel="prefetch" href="/assets/js/27.51cc4dbb.js"><link rel="prefetch" href="/assets/js/28.984bcad5.js"><link rel="prefetch" href="/assets/js/29.23b6a9b4.js"><link rel="prefetch" href="/assets/js/3.91689c96.js"><link rel="prefetch" href="/assets/js/30.b9b53754.js"><link rel="prefetch" href="/assets/js/31.9ee2b382.js"><link rel="prefetch" href="/assets/js/32.aa1e7d4d.js"><link rel="prefetch" href="/assets/js/33.95599c18.js"><link rel="prefetch" href="/assets/js/34.91eec23a.js"><link rel="prefetch" href="/assets/js/35.842185fd.js"><link rel="prefetch" href="/assets/js/36.645d08e2.js"><link rel="prefetch" href="/assets/js/37.d2e53880.js"><link rel="prefetch" href="/assets/js/38.1401a1a9.js"><link rel="prefetch" href="/assets/js/39.6c0d3d3c.js"><link rel="prefetch" href="/assets/js/4.09a575dd.js"><link rel="prefetch" href="/assets/js/40.4038c6d1.js"><link rel="prefetch" href="/assets/js/41.43ae76f7.js"><link rel="prefetch" href="/assets/js/42.1aaebfeb.js"><link rel="prefetch" href="/assets/js/43.c98f9509.js"><link rel="prefetch" href="/assets/js/44.97a11a85.js"><link rel="prefetch" href="/assets/js/45.fc75f295.js"><link rel="prefetch" href="/assets/js/46.d2a82b99.js"><link rel="prefetch" href="/assets/js/47.90b9a3ec.js"><link rel="prefetch" href="/assets/js/48.a5f20f35.js"><link rel="prefetch" href="/assets/js/49.95d58daf.js"><link rel="prefetch" href="/assets/js/5.face5c6e.js"><link rel="prefetch" href="/assets/js/50.4a946785.js"><link rel="prefetch" href="/assets/js/51.74ef85d1.js"><link rel="prefetch" href="/assets/js/52.ab75e264.js"><link rel="prefetch" href="/assets/js/53.04e9a209.js"><link rel="prefetch" href="/assets/js/55.0d6ab8db.js"><link rel="prefetch" href="/assets/js/56.8f313634.js"><link rel="prefetch" href="/assets/js/57.8e9ec077.js"><link rel="prefetch" href="/assets/js/58.445e1ec2.js"><link rel="prefetch" href="/assets/js/59.a81cf678.js"><link rel="prefetch" href="/assets/js/6.9b742511.js"><link rel="prefetch" href="/assets/js/60.0983c596.js"><link rel="prefetch" href="/assets/js/61.34edaa63.js"><link rel="prefetch" href="/assets/js/62.3c1dcc60.js"><link rel="prefetch" href="/assets/js/63.ca5ecc69.js"><link rel="prefetch" href="/assets/js/64.3d87faf8.js"><link rel="prefetch" href="/assets/js/65.bd56dfe3.js"><link rel="prefetch" href="/assets/js/66.ab87e244.js"><link rel="prefetch" href="/assets/js/67.e35259f3.js"><link rel="prefetch" href="/assets/js/68.ec2588e7.js"><link rel="prefetch" href="/assets/js/69.b13a6cfd.js"><link rel="prefetch" href="/assets/js/7.e41a37eb.js"><link rel="prefetch" href="/assets/js/70.8739c828.js"><link rel="prefetch" href="/assets/js/71.a694ddca.js"><link rel="prefetch" href="/assets/js/72.fe3bf48b.js"><link rel="prefetch" href="/assets/js/73.57026e0a.js"><link rel="prefetch" href="/assets/js/74.39a6f866.js"><link rel="prefetch" href="/assets/js/75.8d49462e.js"><link rel="prefetch" href="/assets/js/76.f891bf45.js"><link rel="prefetch" href="/assets/js/77.c8a3af4c.js"><link rel="prefetch" href="/assets/js/78.07521a97.js"><link rel="prefetch" href="/assets/js/79.aee888a3.js"><link rel="prefetch" href="/assets/js/8.f616a798.js"><link rel="prefetch" href="/assets/js/80.cfd0cd53.js"><link rel="prefetch" href="/assets/js/81.707a5ee3.js"><link rel="prefetch" href="/assets/js/82.791bd9b0.js"><link rel="prefetch" href="/assets/js/83.d2599399.js"><link rel="prefetch" href="/assets/js/84.e4773484.js"><link rel="prefetch" href="/assets/js/85.72f88fa5.js"><link rel="prefetch" href="/assets/js/86.ffdf2d1e.js"><link rel="prefetch" href="/assets/js/87.b4227711.js"><link rel="prefetch" href="/assets/js/88.ced4d671.js"><link rel="prefetch" href="/assets/js/89.7ceb6053.js"><link rel="prefetch" href="/assets/js/9.581e98ff.js"><link rel="prefetch" href="/assets/js/90.f1b678cb.js"><link rel="prefetch" href="/assets/js/91.8d1d690b.js"><link rel="prefetch" href="/assets/js/92.867a487f.js"><link rel="prefetch" href="/assets/js/93.49f36484.js"><link rel="prefetch" href="/assets/js/94.8ebd746e.js"><link rel="prefetch" href="/assets/js/95.bc94dbc7.js"><link rel="prefetch" href="/assets/js/96.fb0c9c67.js"><link rel="prefetch" href="/assets/js/97.3ab234c0.js"><link rel="prefetch" href="/assets/js/98.96a4f503.js"><link rel="prefetch" href="/assets/js/99.087cd15a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">LBW's Wiki Pages</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/overview/" class="nav-link">
  概览
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/operating-system/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/computer-network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/distributed-system/" class="nav-link">
  分布式系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/language/c/" class="nav-link">
  C/C++
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/tomcat/" class="nav-link">
  Tomcat
</a></li><li class="dropdown-item"><!----> <a href="/backend/jetty/" class="nav-link">
  Jetty
</a></li><li class="dropdown-item"><!----> <a href="/backend/spring/" class="nav-link router-link-active">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/backend/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/backend/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/microservice/" class="nav-link">
  微服务架构
</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/kubernetes/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/" class="nav-link">
  Dev-Ops
</a></li><li class="dropdown-item"><!----> <a href="/circumvent-internet/" class="nav-link">
  科学上网
</a></li></ul></div></div><div class="nav-item"><a href="https://lebw.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/lebw/my-wiki" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/overview/" class="nav-link">
  概览
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/operating-system/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/computer-network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/distributed-system/" class="nav-link">
  分布式系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/language/c/" class="nav-link">
  C/C++
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/tomcat/" class="nav-link">
  Tomcat
</a></li><li class="dropdown-item"><!----> <a href="/backend/jetty/" class="nav-link">
  Jetty
</a></li><li class="dropdown-item"><!----> <a href="/backend/spring/" class="nav-link router-link-active">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/backend/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/backend/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/microservice/" class="nav-link">
  微服务架构
</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/kubernetes/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/" class="nav-link">
  Dev-Ops
</a></li><li class="dropdown-item"><!----> <a href="/circumvent-internet/" class="nav-link">
  科学上网
</a></li></ul></div></div><div class="nav-item"><a href="https://lebw.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/lebw/my-wiki" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/backend/spring/spring-boot.html" class="sidebar-link">Spring Boot启动流程</a></li><li><a href="/backend/spring/spring-data.html" class="sidebar-link">Spring Data</a></li><li><a href="/backend/spring/spring-security.html" class="sidebar-link">Spring Security</a></li><li><a href="/backend/spring/filter-listener-intecepter.html" class="sidebar-link">过滤器，监听器，拦截器</a></li><li><a href="/backend/spring/cross-domain.html" aria-current="page" class="active sidebar-link">同源政策与跨域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/spring/cross-domain.html#同源策略" class="sidebar-link">同源策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/spring/cross-domain.html#限制范围" class="sidebar-link">限制范围</a></li><li class="sidebar-sub-header"><a href="/backend/spring/cross-domain.html#cookie" class="sidebar-link">Cookie</a></li><li class="sidebar-sub-header"><a href="/backend/spring/cross-domain.html#cors" class="sidebar-link">CORS</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/spring/cross-domain.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="同源政策与跨域"><a href="#同源政策与跨域" class="header-anchor">#</a> 同源政策与跨域</h1> <p>浏览器安全的基石是“同源策略”（same-origin policy）。在理解跨域问题之前，先看看同源策略。</p> <h2 id="同源策略"><a href="#同源策略" class="header-anchor">#</a> 同源策略</h2> <p>同源策略是由 Netscape 公司在 1995 年引入浏览器的。目前，所有浏览器都实行这个政策。</p> <p>最初，它的含义是指：A网页设置的 Cookie，B网页不能打开，除非这两个网页同源。所谓同源指的是“三个相同”。</p> <ul><li>协议相同</li> <li>域名相同</li> <li>端口相同</li></ul> <p>举例来说，<code>http://www.example.com/dir/page.html</code> 这个网址，它的协议是 <code>http://</code>, 域名是 <code>www.example.com</code>，端口是 <code>80</code>。它的同源情况如下：</p> <ul><li><code>http://www.example.com/dir2/other.html</code> 同源</li> <li><code>http://example.com/dir/other.html</code> 不同源，域名不同</li> <li><code>http://v2.www.example.com/dir/other.html</code> 不同源，域名不同</li> <li><code>http://www.example.com:81/dir/other.html</code> 不同源，端口不同</li></ul> <p>同源政策的目的是为了保证用户的信息安全，防止恶意网站窃取数据。</p> <p>设想一种情况，A网站是一家银行，用户登录之后，又去浏览其他网站。如果其他网站可以阅读A网站的 Cookie，会发生很严重的事故。</p> <p>因此，“同源政策”是必须的，否则 Cookie 可以共享，互联网就毫无安全可言了。</p> <h3 id="限制范围"><a href="#限制范围" class="header-anchor">#</a> 限制范围</h3> <p>随着互联网的快速发展，同源政策越来越严格。目前，如果非同源，共有三种行为受到限制：</p> <ul><li>Cookie，LocalStorage 和 IndexDB 无法读取。</li> <li>DOM 无法获得。</li> <li>AJAX 请求不能发送。</li></ul> <p>这些限制是必要的。但是有些情况下，这些限制会导致不方便，合理的用途也会受到影响。下面我们看看如何规避这些限制。</p> <h3 id="cookie"><a href="#cookie" class="header-anchor">#</a> Cookie</h3> <p>首先看看 Cookie。Cookie 是服务器写入浏览器的一小段信息，只有同源网页才能共享。但是，当两个网页的一级域名相同，只是二级域名不同时，浏览器允许通过设置<code>document.domain</code>来共享 Cookie。</p> <p>另外，服务器也可以在设置 Cookie 的时候，指定 Cookie 的所属域名为一级域名，例如 <code>.example.com</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>Set-Cookie: key=value; domain=.example.com; path=/
</code></pre></div><p>这样的话，二级域名和三级域名不用做任何设置，都可以读取这个 Cookie。</p> <blockquote><p>注意，在 Set-Cookie 时，<code>domain</code> 属性是可选的。如果没有指定它，那么默认是当前 URL 的域名，并且子域名是不包括的；如果指定了它，那么所有子域名都是包括在内的。</p></blockquote> <p>另外，以上方法仅适用于 Cookie 的共享，不适用于 LocalStorage 和 IndexDB。其他方法可参阅 <a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h3> <p>同源政策规定，AJAX 只能发送给同源的网址，否则报错。如果我们需要给不同源的网址发送 AJAX 请求，可以使用 跨站资源分享（Cross-Origin Resource Sharing，CORS）。它是 W3C 标准，是解决跨源AJAX请求的根本解决方案。</p> <p>CORS 需要服务器和浏览器同时支持。对于浏览器端，整个 CORS 通信过程都由浏览器自动完成，不需要用户参与。对于开发者来说，CORS 通信与同源的 AJAX 通信没有差别，代码完全相同。浏览器一旦发现 AJAX 请求是跨源的，就会自动添加一些附加的头部信息，有时还会多出一次附加的请求，但用户不会有感觉。</p> <p>因此，实现 CORS 的关键是服务器。只要服务器实现了 CORS 接口，并且浏览器支持，就可以跨源通信。</p> <h4 id="两种请求"><a href="#两种请求" class="header-anchor">#</a> 两种请求</h4> <p>浏览器将 CORS 请求分为两类：简单请求（Simple Request）和非简单请求（not-so-simple request).</p> <p>如果同时满足以下两大条件，就属于简单请求。</p> <div class="language- extra-class"><pre class="language-text"><code>(1) 请求方法是以下三种之一：
* HEAD
* GET
* POST
(2) HTTP 头信息不超出以下几种字段：
* Accept
* Accept-Language
* Content-Language
* Last-Event-ID
* Content-Type: 仅限于三个值 application/x-www-form-urlencoded, multipart/form-data, text/plain
</code></pre></div><p>凡是不同时满足以上两个条件，就属于非简单请求。浏览器对简单请求和非简单请求的处理是不一样的。</p> <h5 id="简单请求"><a href="#简单请求" class="header-anchor">#</a> 简单请求</h5> <p>对于简单请求，浏览器的策略是直接发送 CORS 请求。具体来说，浏览器会在请求的头部信息中添加一个 Origin 字段。</p> <p>下面一个例子，就是一个简单请求，浏览器发现这个 AJAC 是一个简单请求，就自动在头部信息中添加 Origin 字段。</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token property">GET</span> /cors HTTP/1.1</span>
<span class="token header-name keyword">Origin:</span> http://api.bob.com
<span class="token header-name keyword">Host:</span> api.alice.com
<span class="token header-name keyword">Accept-Language:</span> en-US
<span class="token header-name keyword">Connection:</span> keep-alive
<span class="token header-name keyword">User-Agent:</span> Mozilla/5.0...
</code></pre></div><p>上面的头信息中，Origin 字段用来说明，本次请求来自哪个源（协议+域名+端口）。服务器会根据这个值，来决定是否同意这次请求。</p> <p>如果 Origin 指定的源，不在许可范围内，服务器会返回一个正常的HTTP回应。浏览器发现，这个回应的头部信息中没有包含 <code>Access-Control-Allow-Origin</code>字段，就知道服务器不支持 CORS 或者 该请求的Origin不在服务器的允许范围内，因此浏览器抛出一个错误，被 <code>XMLHttpRequest</code>的<code>onerror</code>回调函数捕获。</p> <p>如果 Origin 指定的源，在许可范围内，服务器返回的响应，会多出几个头信息字段：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">Access-Control-Allow-Origin:</span> http://api.bob.com
<span class="token header-name keyword">Access-Control-Allow-Credentials:</span> true
<span class="token header-name keyword">Access-Control-Expose-Headers:</span> FooBar
<span class="token header-name keyword">Content-Type:</span> text/html; charset=utf-8
</code></pre></div><p>上面的头部信息中，有三个与 CORS 有关，都以 <code>Access-Control-</code>开头。</p> <p><code>Access-Control-Allow-Origin</code>字段是必须的，它的值要么是请求时 Origin 的值，要么是一个<code>*</code>，表示接受任何域名的请求。</p> <p><code>Access-Control-Allow-Credentials</code>是可选的。它的值是布尔值，表示是否允许发送 Cookie。默认情况下，Cookie 不包含在 CORS 请求中。设为 <code>true</code> 后，即表示服务器明确许可，Cookie 可以包含在请求中，一起发送给服务器。这个值只能被设为 true，如果服务器不要浏览器发送 Cookie，删除该字段即可。</p> <p><code>Access-Control-Expose-Headers</code>是可选的。对于一般的 CORS 请求，<code>XMLHttpRequest</code>的<code>getResponseHeader()</code>方法只能拿到6个基本字段：<code>Cache-Control</code>, <code>Content-Language</code>, <code>Content-Type</code>, <code>Expires</code>, <code>Last-Modified</code>, <code>Pragma</code>。如果想拿到其他字段，就必须在<code>Access-Control-Expose-Headers</code>字段中指定。例如上面的例子中，<code>getResponseHeader('FooBar')</code>就可以返回<code>FooBar</code>字段的值。</p> <p>另外，上面提到 CORS 请求默认不发送 Cookie 和 HTTP 认证信息。如果要把 Cookie 发送给服务器，一方面要服务器同意，指定 <code>Access-Control-Allow-Credentials</code>为<code>true</code>，另一发面，开发者也必须在 AJAX 请求中打开 withCredentials 属性：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><p>否则，即使服务器同意发送 Cookie，浏览器也不会发送。或者，服务器要求设置 Cookie，浏览器也不会处理。</p> <p>需要注意的是，如果要发送 Cookie，<code>Access-Control-Allow-Origin</code>的值就不能设为 <code>*</code>，而必须指定明确的，与请求网页一致的域名。同时，Cookie 依然遵循同源策略，只有用服务器域名设置的 Cookie 才会上传，其他域名的 Cookie 不会上传，且（跨域）原网页代码中的<code>document.cookie</code>也无法读取服务器域名下的Cookie。</p> <h5 id="非简单请求"><a href="#非简单请求" class="header-anchor">#</a> 非简单请求</h5> <p>非简单请求是那种对服务器有特殊要求的请求，比如请求方法是 <code>PUT</code> 或 <code>DELETE</code>，或者 <code>Content-Type</code>字段的类型是 <code>application-json</code>。</p> <p>对于非简单请求，浏览器会在正式通信之前，增加一次 HTTP 查询请求，被称为 预检请求（preflight）。</p> <p>浏览器首先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些 HTTP 动词和头信息字段。只有得到肯定答复，浏览器才会发出正式的 <code>XMLHttpRequest</code> 请求，否则就报错。</p> <p>下面是一段浏览器的 Javascript 脚本：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://api.alice.com/cors'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'PUT'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Custom-Header'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码中，HTTP请求的方法是 PUT，而且发送了一个自定义头部信息 <code>X-Custom-Header</code>。</p> <p>浏览器发现，这是一个非简单请求，于是发出一个预检请求，要求服务器确认可以这样请求。下面是这个预检请求的HTTP头信息.</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token property">OPTIONS</span> /cors HTTP/1.1</span>
<span class="token header-name keyword">Origin:</span> http://api.bob.com
<span class="token header-name keyword">Access-Control-Request-Method:</span> PUT
<span class="token header-name keyword">Access-Control-Request-Headers:</span> X-Custom-Header
<span class="token header-name keyword">Host:</span> api.alice.com
<span class="token header-name keyword">Accept-Language:</span> en-US
<span class="token header-name keyword">Connetion:</span> keep-alive
<span class="token header-name keyword">User-Agent:</span> ...
</code></pre></div><p>预检请求用的请求方法是 OPTIONS，表示这个请求是用来询问的。头信息里，关键字段是 Origin，表示请求来自哪个源。</p> <p>除了 Origin，请求中还有两个特殊字段：</p> <ul><li><code>Access-Control-Request-Method</code>字段是必须的，用来列出浏览器的 CORS 请求会用到哪些方法。</li> <li><code>Access-Control-Request-Headers</code>字段是可选的，是一个逗号分割的字符串，指定浏览器 CORS 请求还会额外发送的头部字段。</li></ul> <p>服务器收到预检请求后，检查了 <code>Origin</code>, <code>Access-Control-Request-Method</code>, <code>Access-Control-Request-Headers</code>三个字段后，如果确认允许跨域请求，就可以作出回应。</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token response-status">HTTP/1.1 <span class="token property">200 OK</span></span>
<span class="token header-name keyword">Date:</span> Mon, 01 Dec 2008 01:15:39 GMT
<span class="token header-name keyword">Server:</span> Apache/2.0.61 (Unix)
<span class="token header-name keyword">Access-Control-Allow-Origin:</span> http://api.bob.com
<span class="token header-name keyword">Access-Control-Allow-Methods:</span> GET, POST, PUT
<span class="token header-name keyword">Access-Control-Allow-Headers:</span> X-Custom-Header
<span class="token header-name keyword">Content-Type:</span> text/html; charset=utf-8
<span class="token header-name keyword">Content-Encoding:</span> gzip
<span class="token header-name keyword">Content-Length:</span> 0
<span class="token header-name keyword">Keep-Alive:</span> timeout=2, max=100
<span class="token header-name keyword">Connection:</span> Keep-Alive
<span class="token header-name keyword">Content-Type:</span> text/plain
</code></pre></div><p>上面的 HTTP 回应中，关键的是 <code>Access-Control-Allow-Origin</code>字段，表示 <code>http://api.bob.com</code> 可以请求该数据。其他字段意义同理。</p> <p>一旦服务器通过了预检请求，以后浏览器每次发送正常的 CORS 请求，就都跟简单请求一样，会有一个 <code>Origin</code> 头信息字段。服务器的回应，也都会有一个 <code>Access-Control-Allow-Origin</code> 头信息字段。</p> <p>总结，CORS 与 JSONP 的目的相同，但是比 JSONP 更强大。</p> <p>JSONP 只支持 GET 请求，CORS 支持所有类型的 HTTP 请求。JSONP 的优势在于支持老式游览器，以及可以向不支持 CORS 的网站请求数据。</p> <p>Spring 中已经实现了 CORS 相关功能，配置即可。</p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <p><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener noreferrer">跨域资源共享 CORS 详解 - 阮一峰<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backend/spring/filter-listener-intecepter.html" class="prev">
        过滤器，监听器，拦截器
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6eab1976.js" defer></script><script src="/assets/js/2.167d90c7.js" defer></script><script src="/assets/js/54.83caae44.js" defer></script>
  </body>
</html>
