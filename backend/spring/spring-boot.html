<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Boot启动流程 | LBW&#39;s Wiki Pages</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/lbw-wiki.png">
    <meta name="description" content="Organize all of my knowledge.">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.6eab1976.js" as="script"><link rel="preload" href="/assets/js/2.167d90c7.js" as="script"><link rel="preload" href="/assets/js/6.9b742511.js" as="script"><link rel="prefetch" href="/assets/js/10.1ec14536.js"><link rel="prefetch" href="/assets/js/100.d3be4e1b.js"><link rel="prefetch" href="/assets/js/101.971eb1f4.js"><link rel="prefetch" href="/assets/js/102.2ae2fa3b.js"><link rel="prefetch" href="/assets/js/11.ec909d32.js"><link rel="prefetch" href="/assets/js/12.75d6c1db.js"><link rel="prefetch" href="/assets/js/13.fafebc4f.js"><link rel="prefetch" href="/assets/js/14.7da14f0a.js"><link rel="prefetch" href="/assets/js/15.0e8dd2a9.js"><link rel="prefetch" href="/assets/js/16.d9b44fc4.js"><link rel="prefetch" href="/assets/js/17.7a43f1b2.js"><link rel="prefetch" href="/assets/js/18.c16ff94e.js"><link rel="prefetch" href="/assets/js/19.4052930d.js"><link rel="prefetch" href="/assets/js/20.c97d4e30.js"><link rel="prefetch" href="/assets/js/21.fec0ccc6.js"><link rel="prefetch" href="/assets/js/22.b13a8b79.js"><link rel="prefetch" href="/assets/js/23.60db8c03.js"><link rel="prefetch" href="/assets/js/24.0eb76eee.js"><link rel="prefetch" href="/assets/js/25.9bbc378a.js"><link rel="prefetch" href="/assets/js/26.d71f4e99.js"><link rel="prefetch" href="/assets/js/27.51cc4dbb.js"><link rel="prefetch" href="/assets/js/28.984bcad5.js"><link rel="prefetch" href="/assets/js/29.23b6a9b4.js"><link rel="prefetch" href="/assets/js/3.91689c96.js"><link rel="prefetch" href="/assets/js/30.b9b53754.js"><link rel="prefetch" href="/assets/js/31.9ee2b382.js"><link rel="prefetch" href="/assets/js/32.aa1e7d4d.js"><link rel="prefetch" href="/assets/js/33.95599c18.js"><link rel="prefetch" href="/assets/js/34.91eec23a.js"><link rel="prefetch" href="/assets/js/35.842185fd.js"><link rel="prefetch" href="/assets/js/36.645d08e2.js"><link rel="prefetch" href="/assets/js/37.d2e53880.js"><link rel="prefetch" href="/assets/js/38.1401a1a9.js"><link rel="prefetch" href="/assets/js/39.6c0d3d3c.js"><link rel="prefetch" href="/assets/js/4.09a575dd.js"><link rel="prefetch" href="/assets/js/40.4038c6d1.js"><link rel="prefetch" href="/assets/js/41.43ae76f7.js"><link rel="prefetch" href="/assets/js/42.1aaebfeb.js"><link rel="prefetch" href="/assets/js/43.c98f9509.js"><link rel="prefetch" href="/assets/js/44.97a11a85.js"><link rel="prefetch" href="/assets/js/45.fc75f295.js"><link rel="prefetch" href="/assets/js/46.d2a82b99.js"><link rel="prefetch" href="/assets/js/47.90b9a3ec.js"><link rel="prefetch" href="/assets/js/48.a5f20f35.js"><link rel="prefetch" href="/assets/js/49.95d58daf.js"><link rel="prefetch" href="/assets/js/5.face5c6e.js"><link rel="prefetch" href="/assets/js/50.4a946785.js"><link rel="prefetch" href="/assets/js/51.74ef85d1.js"><link rel="prefetch" href="/assets/js/52.ab75e264.js"><link rel="prefetch" href="/assets/js/53.04e9a209.js"><link rel="prefetch" href="/assets/js/54.83caae44.js"><link rel="prefetch" href="/assets/js/55.0d6ab8db.js"><link rel="prefetch" href="/assets/js/56.8f313634.js"><link rel="prefetch" href="/assets/js/57.8e9ec077.js"><link rel="prefetch" href="/assets/js/58.445e1ec2.js"><link rel="prefetch" href="/assets/js/59.a81cf678.js"><link rel="prefetch" href="/assets/js/60.0983c596.js"><link rel="prefetch" href="/assets/js/61.34edaa63.js"><link rel="prefetch" href="/assets/js/62.3c1dcc60.js"><link rel="prefetch" href="/assets/js/63.ca5ecc69.js"><link rel="prefetch" href="/assets/js/64.3d87faf8.js"><link rel="prefetch" href="/assets/js/65.bd56dfe3.js"><link rel="prefetch" href="/assets/js/66.ab87e244.js"><link rel="prefetch" href="/assets/js/67.e35259f3.js"><link rel="prefetch" href="/assets/js/68.ec2588e7.js"><link rel="prefetch" href="/assets/js/69.b13a6cfd.js"><link rel="prefetch" href="/assets/js/7.e41a37eb.js"><link rel="prefetch" href="/assets/js/70.8739c828.js"><link rel="prefetch" href="/assets/js/71.a694ddca.js"><link rel="prefetch" href="/assets/js/72.fe3bf48b.js"><link rel="prefetch" href="/assets/js/73.57026e0a.js"><link rel="prefetch" href="/assets/js/74.39a6f866.js"><link rel="prefetch" href="/assets/js/75.8d49462e.js"><link rel="prefetch" href="/assets/js/76.f891bf45.js"><link rel="prefetch" href="/assets/js/77.c8a3af4c.js"><link rel="prefetch" href="/assets/js/78.07521a97.js"><link rel="prefetch" href="/assets/js/79.aee888a3.js"><link rel="prefetch" href="/assets/js/8.f616a798.js"><link rel="prefetch" href="/assets/js/80.cfd0cd53.js"><link rel="prefetch" href="/assets/js/81.707a5ee3.js"><link rel="prefetch" href="/assets/js/82.791bd9b0.js"><link rel="prefetch" href="/assets/js/83.d2599399.js"><link rel="prefetch" href="/assets/js/84.e4773484.js"><link rel="prefetch" href="/assets/js/85.72f88fa5.js"><link rel="prefetch" href="/assets/js/86.ffdf2d1e.js"><link rel="prefetch" href="/assets/js/87.b4227711.js"><link rel="prefetch" href="/assets/js/88.ced4d671.js"><link rel="prefetch" href="/assets/js/89.7ceb6053.js"><link rel="prefetch" href="/assets/js/9.581e98ff.js"><link rel="prefetch" href="/assets/js/90.f1b678cb.js"><link rel="prefetch" href="/assets/js/91.8d1d690b.js"><link rel="prefetch" href="/assets/js/92.867a487f.js"><link rel="prefetch" href="/assets/js/93.49f36484.js"><link rel="prefetch" href="/assets/js/94.8ebd746e.js"><link rel="prefetch" href="/assets/js/95.bc94dbc7.js"><link rel="prefetch" href="/assets/js/96.fb0c9c67.js"><link rel="prefetch" href="/assets/js/97.3ab234c0.js"><link rel="prefetch" href="/assets/js/98.96a4f503.js"><link rel="prefetch" href="/assets/js/99.087cd15a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">LBW's Wiki Pages</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/overview/" class="nav-link">
  概览
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/operating-system/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/computer-network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/distributed-system/" class="nav-link">
  分布式系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/language/c/" class="nav-link">
  C/C++
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/tomcat/" class="nav-link">
  Tomcat
</a></li><li class="dropdown-item"><!----> <a href="/backend/jetty/" class="nav-link">
  Jetty
</a></li><li class="dropdown-item"><!----> <a href="/backend/spring/" class="nav-link router-link-active">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/backend/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/backend/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/microservice/" class="nav-link">
  微服务架构
</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/kubernetes/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/" class="nav-link">
  Dev-Ops
</a></li><li class="dropdown-item"><!----> <a href="/circumvent-internet/" class="nav-link">
  科学上网
</a></li></ul></div></div><div class="nav-item"><a href="https://lebw.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/lebw/my-wiki" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/overview/" class="nav-link">
  概览
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/operating-system/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/computer-network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/distributed-system/" class="nav-link">
  分布式系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程语言" class="dropdown-title"><span class="title">编程语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="编程语言" class="mobile-dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/language/c/" class="nav-link">
  C/C++
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/tomcat/" class="nav-link">
  Tomcat
</a></li><li class="dropdown-item"><!----> <a href="/backend/jetty/" class="nav-link">
  Jetty
</a></li><li class="dropdown-item"><!----> <a href="/backend/spring/" class="nav-link router-link-active">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/backend/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/backend/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="微服务" class="dropdown-title"><span class="title">微服务</span> <span class="arrow down"></span></button> <button type="button" aria-label="微服务" class="mobile-dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/microservice/" class="nav-link">
  微服务架构
</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/kubernetes/" class="nav-link">
  Kubernetes
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">
  前端
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/devops/" class="nav-link">
  Dev-Ops
</a></li><li class="dropdown-item"><!----> <a href="/circumvent-internet/" class="nav-link">
  科学上网
</a></li></ul></div></div><div class="nav-item"><a href="https://lebw.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/lebw/my-wiki" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/backend/spring/spring-boot.html" aria-current="page" class="active sidebar-link">Spring Boot启动流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#springbootapplication" class="sidebar-link">@SpringBootApplication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#configuration" class="sidebar-link">@Configuration</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#componentscan" class="sidebar-link">@ComponentScan</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#enableautoconfiguration" class="sidebar-link">@EnableAutoConfiguration</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#启动流程" class="sidebar-link">启动流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#创建-springapplication" class="sidebar-link">创建 SpringApplication</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#run-运行过程" class="sidebar-link">run（运行过程）</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_1-preparerefresh" class="sidebar-link">1. prepareRefresh</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_2-preparebeanfactory" class="sidebar-link">2. prepareBeanFactory</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_3-postprocessbeanfactory" class="sidebar-link">3. postProcessBeanFactory</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_4-invokebeanfactorypostprocessor" class="sidebar-link">4. invokeBeanFactoryPostProcessor</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_5-registerbeanpostprocessors" class="sidebar-link">5. registerBeanPostProcessors</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_6-initmessagesource" class="sidebar-link">6. initMessageSource</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_7-initapplicationeventmulticaster" class="sidebar-link">7. initApplicationEventMulticaster</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_8-onrefresh" class="sidebar-link">8. onRefresh</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_9-registerlisteners" class="sidebar-link">9. registerListeners</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_10-finishbeanfactoryinitialization" class="sidebar-link">10. finishBeanFactoryInitialization</a></li><li class="sidebar-sub-header"><a href="/backend/spring/spring-boot.html#_11-finishrefresh" class="sidebar-link">11. finishRefresh</a></li></ul></li></ul></li><li><a href="/backend/spring/spring-data.html" class="sidebar-link">Spring Data</a></li><li><a href="/backend/spring/spring-security.html" class="sidebar-link">Spring Security</a></li><li><a href="/backend/spring/filter-listener-intecepter.html" class="sidebar-link">过滤器，监听器，拦截器</a></li><li><a href="/backend/spring/cross-domain.html" class="sidebar-link">同源政策与跨域</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-boot启动流程"><a href="#spring-boot启动流程" class="header-anchor">#</a> Spring Boot启动流程</h1> <p>开发一个 Spring Boot 项目，都会用到如下启动类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从中可以看出，关键部分有两个，一个是第 1 行的注解 <code>@SpringBootApplication</code>，一个是第 5 行的 <code>SpringApplication.run(...)</code>。
所以要了解 Spring Boot 的启动流程，从这两位入手就可以了。</p> <p>下面氛围两部分：</p> <ol><li>第一部分，从 <code>@SpringBootApplication</code> 入手，从注解的角度看看 SpringBoot 的关键注解。</li></ol> <blockquote><p>注意，在 Java 中，注解只是起到标注的作用，可以理解为一种特殊的 comment，为 类/方法 进行特定标注，本身并不执行代码。真正使注解起作用的，是第二部分的启动过程，利用反射，读取类的注解并进行相应操作。</p></blockquote> <ol start="2"><li>第二部分，从 <code>SpringApplication.run()</code> 入手，了解真实的启动过程。</li></ol> <h2 id="springbootapplication"><a href="#springbootapplication" class="header-anchor">#</a> @SpringBootApplication</h2> <p><code>@SpringBootApplication</code> 是 SpringBoot 应用的核心注解，它其实是一个组合注解：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@SpringBootConfiguration</span>
<span class="token annotation punctuation">@EnableAutoConfiguration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>excludeFilters <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span>CUSTOM<span class="token punctuation">,</span> classes <span class="token operator">=</span> <span class="token class-name">TypeExcludeFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span>CUSTOM<span class="token punctuation">,</span> classes <span class="token operator">=</span> <span class="token class-name">AutoConfigurationExcludeFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">SpringBootApplication</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>虽然使用了多个 Annotation 进行原信息标注，但是其中重要的只有三个：</p> <ul><li><code>@Configuration</code>（点开<code>@SpringBootConfiguration</code>会发现里面还是用了<code>@Configuration</code>）</li> <li><code>@EnableAutoConfiguration</code></li> <li><code>@ComponentScan</code></li></ul> <p>下面分别介绍这三个注解。</p> <h3 id="configuration"><a href="#configuration" class="header-anchor">#</a> @Configuration</h3> <p>这里的 <code>@Configuration</code> 对我们来说应该不陌生，他就是 JavaConfig 形式的 Spring IoC 容器的配置类使用的那个 <code>@Configuration</code>。</p> <p>所以，这里的启动类标注了 <code>@Configuration</code> 后，本身其实也是一个 IoC 容器的配置类。</p> <h3 id="componentscan"><a href="#componentscan" class="header-anchor">#</a> @ComponentScan</h3> <p>这个注解在 Spring 中非常重要，它对应 XML 配置中的元素。<code>@ComponentScan</code> 的功能其实就是自动扫描并加载符合条件的组件（比如 <code>@Component</code> 和 <code>@Repository</code> 等）或者 Bean 定义，最终将这些 Bean 定义加载到 IoC 容器中。</p> <p>我们可以通过 basPackages 等属性来细粒度定制 @ComponentScan 自动扫描的范围。如果不指定，则 Spring 会默认从声明 @ComponentScan 所在类的 package 进行扫描。</p> <blockquote><p>所以 Spring Boot 的启动类最好是放在 root package 下，防止自动扫描范围不对。</p></blockquote> <h3 id="enableautoconfiguration"><a href="#enableautoconfiguration" class="header-anchor">#</a> @EnableAutoConfiguration</h3> <p>这个注解同样非常重要，它主要是借助 @Import 的支持，将所有符合自动配置条件的 bean 定义加载到 IoC 容器中。</p> <p><code>@EnableAutoConfiguration</code> 作为一个复合注解，其自身定义关键信息如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@AutoConfigurationPackage</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">AutoConfigurationImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableAutoConfiguration</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中最关键的就是 <code>@Import(AutoConfigurationImportSelector.class)</code>，借助 <code>@AutoConfigurationImportSelector</code>，可以帮助 Spring Boot 应用将所有符合条件的 <code>@Configuration</code> 配置都加载到当前 IoC 容器中。
就像一只“八爪鱼”一样，借助 Spring 框架原有的一个工具类：SpringFactoriesLoader 的支持，<code>@EnableAutoConfiguration</code> 可以智能的自动配置功效才大功告成。</p> <p><img src="/assets/img/enableautoconfiguration.438fe6e8.png" alt="EnableAutoConfiguration"></p> <p>上面提到的 SpringFactoriesLoader 在 Spring 中用到的地方非常多，其主要功能就是从指定的配置文件 <code>META-INF/spring.factories</code> 中加载配置。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SpringFactoriesLoader</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadFactories</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> factoryClass<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadFactoryNames</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factoryClass<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>配合 <code>@EnableAutoConfiguration</code> 使用时，它提供了一种配置查找的功能支持，即根据 <code>@EnableAutoConfiguration</code> 的完整类名 <code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code> 作为查找的 key，获取对应的一组 <code>@Configuration</code> 类。</p> <p><img src="/assets/img/spring-factories-loader.685a0c01.jpeg" alt="SpringFactoriesLoader"></p> <p>上图是从 Spring Boot 的 autoconfigure 依赖包中的 <code>META-INF/spring.factories</code> 中摘录的一段内容，可以很好的说明问题。</p> <p>所以，<code>@EnableAutoConfiguration</code> 自动配置的魔法其实是：</p> <ul><li>从 classpath 中搜寻所有的 <code>META-INF/spring.factories</code> 配置文件，并将其中 <code>org.springframework.boot.autoconfigure.EnableutoConfiguration</code> 对应的配置项通过反射（Java Refletion）实例化为对应的标注了 <code>@Configuration</code> 的 JavaConfig 形式的 IoC 容器配置类，然后汇总并加载到 IoC 容器.</li></ul> <p>相关代码可以从 <code>AutoConfigurationImportSelector.getCandidateConfigurations()</code> 中看出端倪：</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCandidateConfigurations</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">AnnotationAttributes</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里就是利用 SpringFactoiresLoader 从 spring.factories 中读取 @EnableAutoConfiguration 的类</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> configurations <span class="token operator">=</span> <span class="token class-name">SpringFactoriesLoader</span><span class="token punctuation">.</span><span class="token function">loadFactoryNames</span><span class="token punctuation">(</span><span class="token function">getSpringFactoriesLoaderFactoryClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>configurations<span class="token punctuation">,</span> <span class="token string">&quot;No auto configuration classes found in META-INF/spring.factories. If you &quot;</span>
				<span class="token operator">+</span> <span class="token string">&quot;are using a custom packaging, make sure that file is correct.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> configurations<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>具体细节在第二部分介绍。</p> <h2 id="启动流程"><a href="#启动流程" class="header-anchor">#</a> 启动流程</h2> <p>SpringBoot 应用的 main 函数一般是</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SpringBootExampleApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>点进 run 函数，可以发现关键代码为：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> primarySources<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span>primarySources<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从中可以看出，SpringBoot 的启动过程从大体上可以分为两步：</p> <ul><li>创建 SpringApplication，即 <code>new SpringApplication(primarySources)</code> 的过程。</li> <li>运行 SpringApplication，即 <code>.run(args)</code> 的过程。
下面分别讲讲两部分</li></ul> <h3 id="创建-springapplication"><a href="#创建-springapplication" class="header-anchor">#</a> 创建 SpringApplication</h3> <p>创建 SpringApplication 的过程主要代码为：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> primarySources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> resourceLoader<span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>primarySources<span class="token punctuation">,</span> <span class="token string">&quot;PrimarySources must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// primarySources 一般为应用的主类，在这里就是上面的 SpringBootExampleApplication 类</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>primarySources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>primarySources<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// deduceFromClasspath() 主要使用 Class.isPresent() 来判断当前应用的类型（Reactive 还是 Servlet）</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationType <span class="token operator">=</span> <span class="token class-name">WebApplicationType</span><span class="token punctuation">.</span><span class="token function">deduceFromClasspath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// getSpringFactoriesInstances(Class&lt;T&gt; type) 函数主要是利用 SpringFactoriesLoader 去 META-INF/spring.factories 中寻找 key 为 type 的类，并对其实例化</span>
    <span class="token comment">// 实例化 key 为 org.springframework.boot.BootstrapRegistryInitializer 的类</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bootstrapRegistryInitializers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">BootstrapRegistryInitializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 实例化 key 为 org.springframework.context.ApplicationContextInitializer 的类</span>
    <span class="token function">setInitializers</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContextInitializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 实例化 key 为 org.springframework.context.ApplicationListener 的类</span>
    <span class="token function">setListeners</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 利用方法调用栈，寻找方法名为 main 的方法，并将其对应的类作为主类</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mainApplicationClass <span class="token operator">=</span> <span class="token function">deduceMainApplicationClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>简单来说，这一步做的是将一些关键信息保存在 SpringApplication 的属性中，为后面做准备。</p> <h3 id="run-运行过程"><a href="#run-运行过程" class="header-anchor">#</a> run（运行过程）</h3> <p>运行过程的主要代码在 SpringApplication 类中的 run 函数中</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 记录应用的启动时间</span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建应用的引导上下文</span>
    <span class="token comment">// 主要做的事情是获取到之前加载的所有 bootstrappers，然后挨个执行其 initialize 方法来完成对引导启动器上下文的环境设置</span>
    <span class="token class-name">DefaultBootstrapContext</span> bootstrapContext <span class="token operator">=</span> <span class="token function">createBootstrapContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">configureHeadlessProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从 spring.factories 中获取所有的 SpringApplicationRunListeners</span>
    <span class="token comment">// 默认情况下，SpringBoot 里这里会有唯一一个 SpringApplicationRunListener，即 EventPublishingRunListener</span>
    <span class="token comment">// EventPublishingRunListener 在初始化的时候，会将 SpringApplication 中的 属性 listeners（即 ApplicationListener）赋值</span>
    <span class="token comment">// 然后在调用相关方法时，使用 Multicaster 广播给所有的 ApplicationListener。</span>
    <span class="token class-name">SpringApplicationRunListeners</span> listeners <span class="token operator">=</span> <span class="token function">getRunListeners</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历所有 listeners，调用其 starting 方法。</span>
    <span class="token comment">// 广播 ApplicationStartingEvent。相当于通知所有的 ApplicationListener，应用正在 starting。</span>
    listeners<span class="token punctuation">.</span><span class="token function">starting</span><span class="token punctuation">(</span>bootstrapContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainApplicationClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 构建应用程序参数持有类</span>
        <span class="token class-name">ApplicationArguments</span> applicationArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultApplicationArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建并配置好当前 SpringBoot 应用将要使用的环境；</span>
        <span class="token comment">// 广播 ApplicationEnvironmentPreparedEvent 事件，相当于通知所有的 ApplicationListener，应用环境准备好了</span>
        <span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token function">prepareEnvironment</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> bootstrapContext<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">configureIgnoreBeanInfo</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 控制台上打印 banner</span>
        <span class="token class-name">Banner</span> printedBanner <span class="token operator">=</span> <span class="token function">printBanner</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建 SpringBoot 应用上下文。</span>
        <span class="token comment">// 默认情况下，这里创建的是 AnnotationConfigServletWebServerApplicationContext。</span>
        context <span class="token operator">=</span> <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setApplicationStartup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationStartup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 准备应用上下文，里面会依次调用之前创建的 ApplicationContextInitializer，对 context 进行初始化操作；</span>
        <span class="token comment">// 之后还会广播 ApplicationContextInitializedEvent 给所有的 listeners。</span>
        <span class="token comment">// 然后将 sources（默认为 primarySources，即应用的主类） 加载进上下文</span>
        <span class="token comment">// 最后广播 ApplicationPreparedEvent 事件，告诉 listeners，应用上下文已经准备好了。</span>
        <span class="token function">prepareContext</span><span class="token punctuation">(</span>bootstrapContext<span class="token punctuation">,</span> context<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">,</span> printedBanner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// refresh 是非常关键的一步，里面会做很多事情，例如 BeanFactory 的设置，BeanFactoryPostProcessor 的执行，BeanPostProcessor 接口的执行，</span>
        <span class="token comment">// 自动化配置类的解析、条件注解的解析、国际化的初始化等等。具体在下面再单独讲解</span>
        <span class="token function">refreshContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// refresh 之后应该做的事情，目前是个空实现</span>
        <span class="token function">afterRefresh</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算启动花的时间，并在日志中打印</span>
        <span class="token class-name">Duration</span> timeTakenToStartup <span class="token operator">=</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofNanos</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logStartupInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">StartupInfoLogger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mainApplicationClass<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logStarted</span><span class="token punctuation">(</span><span class="token function">getApplicationLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeTakenToStartup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 广播 ApplicationStartedEvent 事件，通知所有 ApplicationListener，应用已经启动了</span>
        listeners<span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> timeTakenToStartup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用上下文中的 ApplicationRunner 和 CommandRunner 接口的实现类</span>
        <span class="token function">callRunners</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleRunFailure</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ex<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 计算ready花的时间，并广播 ApplicationReadyEvent 事件至所有监听者 listeners</span>
        <span class="token class-name">Duration</span> timeTakenToReady <span class="token operator">=</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofNanos</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        listeners<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> timeTakenToReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleRunFailure</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ex<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样 run 方法执行完毕后，Spring 容器初始化工作完毕，各种监听器、初始化器也做了相应工作。</p> <p>下面具体看一下 <code>refreshContext(context)</code> 这一步。</p> <p>还是以 web 程序为例，这里对应的上下文为 <code>AnnotationConfigServletWebServerApplicationContext</code>。它的 refresh 方法调用了父类 <code>AbstractApplicationContext</code> 的 refresh 方法。</p> <p>下面首先给出 refresh 的主要代码，然后解释其中的主要方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
    <span class="token comment">// refresh 过程只能一个线程处理，不允许并发执行</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StartupStep</span> contextRefresh <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationStartup<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;spring.context.refresh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Prepare this context for refreshing.</span>
        <span class="token comment">// 刷新前的准备，包括 设置flag、时间、初始化 properties 等。</span>
        <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Tell the subclass to refresh the internal bean factory.</span>
        <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Prepare the bean factory for use in this context.</span>
        <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Allows post-processing of the bean factory in context subclasses.</span>
            <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">StartupStep</span> beanPostProcess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationStartup<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;spring.context.beans.post-process&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Invoke factory processors registered as beans in the context.</span>
            <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Register bean processors that intercept bean creation.</span>
            <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanPostProcess<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Initialize message source for this context.</span>
            <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Initialize event multicaster for this context.</span>
            <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Initialize other special beans in specific context subclasses.</span>
            <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Check for listener beans and register them.</span>
            <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Instantiate all remaining (non-lazy-init) singletons.</span>
            <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Last step: publish corresponding event.</span>
            <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exception encountered during context initialization - &quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;cancelling refresh attempt: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Destroy already created singletons to avoid dangling resources.</span>
            <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Reset 'active' flag.</span>
            <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Propagate exception to caller.</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Reset common introspection caches in Spring's core, since we</span>
            <span class="token comment">// might not ever need metadata for singleton beans anymore...</span>
            <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            contextRefresh<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-preparerefresh"><a href="#_1-preparerefresh" class="header-anchor">#</a> 1. prepareRefresh</h3> <ol><li>设置容器的启动时间，撤销关闭状态，开启活跃状态。</li> <li>初始化属性源信息（Property）。</li> <li>验证环境信息里一些必须存在的属性。</li></ol> <h3 id="_2-preparebeanfactory"><a href="#_2-preparebeanfactory" class="header-anchor">#</a> 2. prepareBeanFactory</h3> <ol><li>设置 beanFactory 的类加载器为当前上下文的类加载器，添加属性编辑注册器（<code>PropertyEditorRegistrar</code>）</li> <li>添加 ApplicationContextAwareProcessor 这个 BeanPostProcessor，并取消相关 7 个接口的自动注入，因为 ApplicationContextAwareProcessor 把这些接口的实现工作做了。ApplicationContextAwareProcessor 的作用是让 bean 在实现了 <code>EnvironmentAware</code> 等 7 个接口后，可以感知到应用上下文的相关属性。</li> <li>设置特殊类型对应的bean。BeanFactory 对应刚刚获取到的 beanFactory；ResourceLoader、ApplicationEventPublisher、ApplicationContext 这三个接口对应的 bean 都设置为当前上下文。</li> <li>注册 ApplicationListenerDetector 这个 BeanPostProcessor。</li> <li>注入一些其他信息的 bean，例如 environment、systemProperties 等。</li></ol> <h3 id="_3-postprocessbeanfactory"><a href="#_3-postprocessbeanfactory" class="header-anchor">#</a> 3. postProcessBeanFactory</h3> <p>准备好 beanFactory 后的一些后续操作，不同的上下文会执行不同的操作。</p> <ul><li><code>GenericWebApplicationContext</code> 会在 beanFactory 中添加 <code>ServletContextAwareProcessor</code>，该处理器用于处理实现了 <code>ServletContextAware</code> 接口的 bean。这种类型的 bean 在初始化时，可以感知到 servletContext 和 servletConfig。</li> <li>另外，<code>AnnotationConfigEmbeddedWebApplicationContext</code> 对应的 postProcessBeanFactory方法为：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用父类，即 GenericWebApplicationContext 对应的 postProcessBeanFactory 函数</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查看 basePackages 属性。如果设置了该属性，会使用 ClassPathBeanDefinitionScanner 去扫描 basePackages 包下的 bean 并注册</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 查看 annotatedClasses 属性，如果设置了会使用 AnnotatedBeanDefinitionReader 去注册这些 bean</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>annotatedClasses<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">toClassArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>annotatedClasses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-invokebeanfactorypostprocessor"><a href="#_4-invokebeanfactorypostprocessor" class="header-anchor">#</a> 4. invokeBeanFactoryPostProcessor</h3> <p>在 Spring 上下文中找出实现了 BeanFactoryPostProcessor 接口的 processors 并执行。
Spring 上下文会委托给 PostProcessorRegistrationDelegate 的 invokeBeanFactoryPostProcessors 方法执行。</p> <blockquote><p>BeanFactoryPostProcessor 的作用是用来修改 Spring 上下文中已经存在的 bean 的定义，使用 ConfigurableListableBeanFactory 对 bean 进行处理。</p></blockquote> <p>这里的处理逻辑如下。</p> <p>首先从 Spring 上下文中找出类型为 <code>BeanDefinitionRegistryPostProcessor</code> 的 bean（这些 processor 是在容器刚创建时通过构造 AnnotatedBeanDefinitionReader 的时候注册到容器中的），然后按照优先级分别执行。优先级的逻辑如下：</p> <ol><li>先把实现了 PriorityOrdered 接口的 BeanDefinitionRegistryPostProcessor 全部找出来，排序后依次执行其 <code>postProcessBeanDefinitionRegistry</code> 方法。</li> <li>把实现了 Ordered 接口的 BeanDefinitionRegistryPostProcessor 全部找出来，排序后依次执行。</li> <li>剩下的 BeanDefinitionRegistryPostProcessor 全部找出来并依次执行。</li> <li>然后执行以上所有 processor 的 <code>postProcessBeanFactory</code> 接口（因为 <code>BeanDefinitionRegistryPostProcessor</code> 接口是 <code>BeanFactoryPostProcessor</code> 的子类，所以一定可以找到 <code>postProcessBeanFactory</code> 接口）。</li></ol> <p>接下来从 Spring 上下文中找出类型为 <code>BeanFactoryPostProcessor</code> 的 bean（会忽略掉上面的 bean），然后执行。
这里的查找规则与上面的 BeanDefinitionRegistryPostProcessor 相同，先找 PriorityOrdered，再找 Ordered，最后是两者都没有的。</p> <p>这里需要重点说明的是 <code>ConfigurationClassPostProcessor</code> 这个 processor，因为这个 processor 是处理 <code>@Configuration</code> 注解的，在 SpringBoot 中非常重要。</p> <p><code>ConfigurationClassPostProcessor</code> 是优先级最高的 processor（因为其实现了 PriorityOrdered 接口）。</p> <p>这个 processor 会去 BeanFactory 中找出所有带有 @Configuration 注解的 bean，然后使用 ConfigurationClassParser 去解析这个类。</p> <p>ConfigurationClassParser 内部有个 <code>Map&lt;ConfigurationClass, ConfigurationClass&gt;</code> 类型的 configurationClasses，用于保存已经解析的 Configuration 类。
ConfigurationClass 是一个对要解析的配置类的封装，内部存储了配置类的注解信息、被 @Bean 注解修饰的方法、@ImportResource 注解修饰的信息、ImportBeanDefinitionRegistrar 等。</p> <blockquote><p>这里 ConfigurationClassPostProcessor 最先被处理还有另外一个原因是如果程序中有自定义的 BeanFactoryPostProcessor，那么这个 PostProcessor 首先得通过 ConfigurationClassPostProcessor 被解析出来，然后才能被 Spring 容器找到并执行。(ConfigurationClassPostProcessor 不先执行的话，这个 Processor 是不会被解析的，不会被解析的话也就不会执行了)。</p></blockquote> <p>在简单的程序中，只有主类 SpringBootExampleApplication 有 @Configuration 注解（@SpringBootApplication 中包含此注解），所以这个配置类会被 ConfigurationClassParser 解析。
解析过程如下：</p> <ol><li>处理 @PropertySource 注解，进行配置信息的解析。</li> <li>处理 @ComponentScan 注解，使用 ComponentScanAnnotationParser 扫描 basePackage 下需要解析的类 (@SpringBootApplication 注解也包括了 @ComponentScan 注解，只不过 basePackages 是空的，空的话会去获取当前 @Configuration 修饰的类所在的包)，并注册到 BeanFactory 中(这个时候bean并没有进行实例化，而只是进行了注册。具体的实例化在 finishBeanFactoryInitialization 方法中执行)。对于扫描出来的类，递归解析。</li> <li>处理 @Import 注解，先递归找出所有注解，然后过滤出只有 @Import 注解的类，得到 @Import 注解的值。找出所有的 @Import 注解后，开始处理逻辑
<ol><li>遍历这些 <code>@Import</code> 注解内部的属性类集合。</li> <li>如果这个类是 <code>ImportSelector</code> 接口的实现类，实例化这个 ImportSelector。如果这个类还是 <code>DeferredImportSelector</code> 接口的实现类，那么加入 ConfigurationClassParser 的 <code>deferredImportSelectors</code> 属性中，让第 6 步处理；否则调用 ImportSelector 的 <code>selectImports</code> 方法得到需要 import 的类，然后对这些类递归做 @Import 注解的处理。</li> <li>如果这个类是 <code>ImportBeanDefinitionRegistrar</code> 接口的实现类，设置到配置类的 importBeanDefinitionRegistrars 属性中。</li> <li>其他情况，把这个类加入到 configurationClassParser 的 importStack（队列）属性中，然后把这个类当作 @Configuration 修饰的类，递归重头开始解析这个类。</li></ol></li> <li>处理 @ImportResource 注解：获取 @ImportResource 注解的 locations 属性，得到资源文件的地址信息，然后遍历这些资源文件，并把它们添加到配置类的 importedResources 属性中</li> <li>处理 @Bean 注解：获取被 @Bean 修饰的方法，然后添加到配置类的 beanMethods 属性中</li> <li>处理 DeferredImportSelector：处理第 3 步 @Import 产生的 deferredImportSelector，调用其 Group 类的 process 方法，找到需要 import 的类，然后调用第 3 步相同的逻辑进行处理（注意是所有的配置类处理完之后才会执行这一步）。</li></ol> <blockquote><p>比如查找 @SpringBootApplication 注解的 @Import 注解数据的话，首先发现 @SpringBootApplication 不是一个 @Import 注解，然后递归调用修饰了 @SpringBootApplication 的注解，发现有个 @EnableAutoConfiguration 注解，再次递归发现被 @Import(AutoConfigurationImportSelector.class) 修饰，还有 @AutoConfigurationPackage 注解，再次递归该注解，发现被 @Import(AutoConfigurationPackages.Registrar.class) 修饰。所以 @SpringBootApplication 对应的 @Import 注解有两个，分别是 @Import(AutoConfigurationPackages.Registrar.class) 和 @Import(EnableAutoConfigurationImportSelector.class)。找出所有的 <code>@Import</code> 注解后，开始处理逻辑。</p></blockquote> <p>这里 @SpringBootApplication 注解被 @EnableAutoConfiguration 修饰，@EnableAutoConfiguration 注解被 @Import(AutoConfigurationImportSelector.class) 修饰。
所以在第 3 步中，会找出这个被 @Import 修饰的类 <code>AutoConfigurationImportSelector</code>。</p> <p><img src="/assets/img/spring-boot-import.de557d39.png" alt="spring-boot-import"></p> <p>这个类刚好实现了 <code>DeferredImportSelector</code> 接口，因此会在第 6 步被执行。
第 6 步 selectImport 得到的类就是自动化配置类。</p> <p>需要注意的是，<code>AutoConfigurationImportSelector</code> 由于实现了 <code>DeferredImportSelector</code> 接口，并不是直接调用其 <code>selectImport</code> 方法，而是调用其子类 <code>AutoConfigurationGroup</code> 的 <code>process</code> 方法，然后在其中调用 <code>getAutoConfigurationEntry</code> 来读取自动配置类的。</p> <blockquote><p>因此直接在 <code>AutoConfigurationImportSelector$selectImport</code> 方法里打断点时，会发现执行不到。比较神奇。</p></blockquote> <p>在当前 processor 中，ConfigurationClassParser 解析完配置类后，会将解析完的类存放在其 configurationClasses 属性中。
然后，processor 会创建一个 ConfigurationClassBeanDefinitionReader 去解析这些配置类。</p> <p>下面这段代码是 ConfigurationClassBeanDefinitionReader 解析配置类的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> configurationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TrackedConditionEvaluator</span> trackedConditionEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackedConditionEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass <span class="token operator">:</span> configurationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对每个配置类，调用 loadBeanDefinitionsForConfigurationClass 方法</span>
        <span class="token function">loadBeanDefinitionsForConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> trackedConditionEvaluator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitionsForConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span>
    <span class="token class-name">TrackedConditionEvaluator</span> trackedConditionEvaluator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用条件注解判断是否需要跳过这个配置类</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>trackedConditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 跳过配置类的话，在Spring容器中移除bean的注册</span>
    <span class="token class-name">String</span> beanName <span class="token operator">=</span> configClass<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">removeBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>importRegistry<span class="token punctuation">.</span><span class="token function">removeImportingClassFor</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果自身是被 @Import 注释所 import 的，注册自己</span>
    <span class="token function">registerBeanDefinitionForImportedConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 注册方法中被 @Bean 注解修饰的bean</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanMethod</span> beanMethod <span class="token operator">:</span> configClass<span class="token punctuation">.</span><span class="token function">getBeanMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">loadBeanDefinitionsForBeanMethod</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 注册 @ImportResource 注解注释的资源文件中的 bean</span>
  <span class="token function">loadBeanDefinitionsFromImportedResources</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getImportedResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册 @Import 注解中的 ImportBeanDefinitionRegistrar 接口的 registerBeanDefinitions</span>
  <span class="token function">loadBeanDefinitionsFromRegistrars</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getImportBeanDefinitionRegistrars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>稍微总结一下，invokeBeanFactoryProcessors 方法总的来说就是从 Spring 上下文中找出 BeanDefinitionRegistryPostProcessor 和 BeanFactoryPostProcessor 接口的实现类，并按照一定顺序执行。</p> <p>其中 ConfigurationClassPostProcessor 这个 BeanDefinitionRegistryPostProcessor 优先级最高，它会对项目中的 @Configuration 注解修饰的类（还有 @Component，@ComponentScan，@Import，@ImportResource 修饰的类也会被处理）进行解析，解析完成后把这些 bean 注册到 BeanFactory 中。</p> <blockquote><p>需要注意的是，这个时候注册进来的 bean 还没有被实例化。</p></blockquote> <p>下图是对 ConfigurationClassPostProcessor 的总结：
<img src="/assets/img/configuration-annotation-process.7786e550.png" alt="configuration-annotation-process"></p> <h3 id="_5-registerbeanpostprocessors"><a href="#_5-registerbeanpostprocessors" class="header-anchor">#</a> 5. registerBeanPostProcessors</h3> <p>这一步的主要目的是从 Spring 上下文中找出实现了 BeanPostProcessor 接口的 bean，并设置到 beanFactory 的 <code>beanPostProcessors</code> 属性中。
之后 bean 被实例化的时候，相关 BeanPostProcessor 会被调用。</p> <p>该方法委托给了 PostProcessorRegistrationDelegate 类的 <code>registerBeanPostProcessors</code> 方法执行。这里的过程与 <code>invokeBeanFactoryPostProcessors</code> 类似：</p> <ol><li>先找出实现了 PriorityOrdered 接口的 BeanPostProcessor，然后排序，然后加载到 BeanFactory 的 BeanPostProcessor 集合中。</li> <li>再找出实现了 Ordered 接口的 BeanPostProcessor，然后排序，然后加载到 BeanFactory 的 BeanPostProcessor 集合中。</li> <li>再找出剩下的 BeanPostProcessors，排序后加入到 BeanFactory 的 BeanPostProcessor 集合中。</li></ol> <p>在注册之前，beanFactory 里有 4 个 beanPostProcessors，它们是：
<img src="/assets/img/before-register-post-processor.41f58ac6.png" alt="before-register-post-processor"></p> <p>注册之后，beanFactory 里有 11 个 beanPostProcessors，它们是：
<img src="/assets/img/after-register-post-processor.c4b395d8.png" alt="after-register-post-processor"></p> <p>这里的 beanPostProcessors 包括 AutowiredAnnotationBeanPostProcessor（用来处理被 @Autowired 注释修饰的 bean） 等。</p> <h3 id="_6-initmessagesource"><a href="#_6-initmessagesource" class="header-anchor">#</a> 6. initMessageSource</h3> <p>配置 beanFactory 的 <code>messageSource</code> 属性，可以用来做类似国际化的事情。</p> <h3 id="_7-initapplicationeventmulticaster"><a href="#_7-initapplicationeventmulticaster" class="header-anchor">#</a> 7. initApplicationEventMulticaster</h3> <p>在 Spring 上下文中初始化事件广播器，事件广播器用于事件的发布。</p> <p>具体来说，在 Spring 上下文中寻找名称为 applicationEventMulticaster 的 bean：</p> <ul><li>找到的话，将其设置为 beanFactory 的 <code>applicationEventMulticaster</code> 属性。</li> <li>如果找不到该 bean 的话，则 new 一个 SimpleApplicationEventMulticaster 并设置为 <code>applicationEventMulticaster</code>。</li></ul> <h3 id="_8-onrefresh"><a href="#_8-onrefresh" class="header-anchor">#</a> 8. onRefresh</h3> <p>根据 context 的类型，创建一些特殊的 bean。</p> <p>例如，web 程序的上下文 AnnotationConfigEmbeddedWebApplicationContext 会调用 createEmbeddedServletContainer 方法去创建内置的 Servlet 容器。</p> <p>目前 SpringBoot 支持的内置容器有：</p> <ul><li>Tomcat、Jetty、Netty、Undertow</li></ul> <h3 id="_9-registerlisteners"><a href="#_9-registerlisteners" class="header-anchor">#</a> 9. registerListeners</h3> <p>把 Spring 上下文中的应用监听器（applicationListeners）都注册到事件广播器（applicationEventMulticater）中。</p> <p>然后在 Spring 上下文的 beanFactory 中寻找所有实现了 ApplicationListener 接口的 bean，将它们也加入到 applicationEventMulticater 中。（注意这里并不对它们做实例化，仅仅把 beanName 加入进去）</p> <h3 id="_10-finishbeanfactoryinitialization"><a href="#_10-finishbeanfactoryinitialization" class="header-anchor">#</a> 10. finishBeanFactoryInitialization</h3> <p>实例化 beanFactory 中已经被注册但是还没有实例化的所有 bean。（除了懒加载的 bean）。</p> <p>例如上面 <code>invokeBeanFactoryPostProcessors</code> 方法根据各种注解解析出来的 bean，这个时候都会被实例化。</p> <p>实例化的过程中，beanPostProcessor 开始起作用。</p> <h3 id="_11-finishrefresh"><a href="#_11-finishrefresh" class="header-anchor">#</a> 11. finishRefresh</h3> <p>refresh 结束阶段需要做的事情。</p> <ol><li>初始化生命周期处理器，并设置到 Spring 上下文的 <code>lifecycleProcessor</code> 属性中。</li> <li>调用 <code>lifecycleProcessor</code> 的 <code>onRefresh</code> 方法，这个方法会找出 Spring 上下文中实现了 SmartLifecycle 接口的类，并进行 start 方法的调用。</li> <li>发布 ContextRefreshedEvent 事件告知 applicationListeners，进行相应操作。</li> <li>调用 LiveBeansView 的 <code>registerApplicationContext</code> 方法：如果设置了 JMX 相关的属性，则就调用该方法。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/backend/spring/spring-data.html">
        Spring Data
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6eab1976.js" defer></script><script src="/assets/js/2.167d90c7.js" defer></script><script src="/assets/js/6.9b742511.js" defer></script>
  </body>
</html>
