(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{426:function(e,t,a){e.exports=a.p+"assets/img/lvm.144fbc44.png"},506:function(e,t,a){"use strict";a.r(t);var n=a(45),s=Object(n.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"文件系统"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#文件系统"}},[e._v("#")]),e._v(" 文件系统")]),e._v(" "),n("p",[e._v("本节记录 Linux 操作系统中的文件系统相关概念和操作。")]),e._v(" "),n("h2",{attrs:{id:"利用fdisk对硬盘重新分区"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#利用fdisk对硬盘重新分区"}},[e._v("#")]),e._v(" 利用fdisk对硬盘重新分区")]),e._v(" "),n("p",[e._v("fdisk是操作硬盘分区表的工具。输入"),n("code",[e._v("fdisk /dev/vda")]),e._v("以对该硬盘进行分区操作.输出为：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("[root@virt2 ~]# fdisk /dev/vda\nWelcome to fdisk (util-linux 2.23.2).\n\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\n\nCommand (m for help): m\nCommand action\n   a   toggle a bootable flag\n   b   edit bsd disklabel\n   c   toggle the dos compatibility flag\n   d   delete a partition\n   g   create a new empty GPT partition table\n   G   create an IRIX (SGI) partition table\n   l   list known partition types\n   m   print this menu\n   n   add a new partition\n   o   create a new empty DOS partition table\n   p   print the partition table\n   q   quit without saving changes\n   s   create a new empty Sun disklabel\n   t   change a partition's system id\n   u   change display/entry units\n   v   verify the partition table\n   w   write table to disk and exit\n   x   extra functionality (experts only)\n")])])]),n("p",[e._v("在输入m后得到了操作表。首先我们输入p以查看当前的分区表。")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Command (m for help): p\n\nDisk /dev/vda: 214.7 GB, 214748364800 bytes, 419430400 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x000c411d\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/vda1   *        2048    62916607    31457280   83  Linux\n/dev/vda2        62916608    67108863     2096128   82  Linux swap / Solaris\n\nCommand (m for help):\n")])])]),n("p",[e._v("在这里我们发现问题：\n硬盘容量有 214.7GB，但是分区1仅仅使用 30GB，分区2仅仅使用 2GB，也就是说还有很大一部分的硬盘容量没有利用起来。于是这里我们需要对硬盘重新分区。")]),e._v(" "),n("p",[e._v("首先使用d命令删除当前的两个分区表")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Command (m for help): d\nPartition number (1,2, default 2):\nPartition 2 is deleted\n\nCommand (m for help): d\nSelected partition 1\nPartition 1 is deleted\n\nCommand (m for help):\n")])])]),n("p",[e._v("然后使用n命令新建两个分区表。与之前一样，一个用来当启动分区，一个用于交换。由于一共有200G空间，我决定给启动分区184G的空间，交换分区16G的空间。关于交换分区的大小，可以参考"),n("a",{attrs:{href:"https://www.tldp.org/HOWTO/Partition/requirements.html#SwapSize",target:"_blank",rel:"noopener noreferrer"}},[e._v("此文档"),n("OutboundLink")],1),e._v(".")]),e._v(" "),n("p",[e._v("分区1创建过程如下：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Command (m for help): n\nPartition type:\n   p   primary (0 primary, 0 extended, 4 free)\n   e   extended\nSelect (default p): p\nPartition number (1-4, default 1): 1\nFirst sector (2048-419430399, default 2048):\nUsing default value 2048\nLast sector, +sectors or +size{K,M,G} (2048-419430399, default 419430399): +184G\nPartition 1 of type Linux and of size 184 GiB is set\n\n")])])]),n("p",[e._v("其中的技巧是使用"),n("code",[e._v("+184G")]),e._v("来指定分区大小，从而让fdisk为我们计算结束扇区。")]),e._v(" "),n("p",[e._v("分区二创建过程如下：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Command (m for help): n\nPartition type:\n   p   primary (1 primary, 0 extended, 3 free)\n   e   extended\nSelect (default p): p\nPartition number (2-4, default 2): 2\nFirst sector (385878016-419430399, default 385878016):\nUsing default value 385878016\nLast sector, +sectors or +size{K,M,G} (385878016-419430399, default 419430399):\nUsing default value 419430399\nPartition 2 of type Linux and of size 16 GiB is set\n")])])]),n("p",[e._v("其中无需更改扇区结束处，因为fdisk默认会使用所有未分配的容量。")]),e._v(" "),n("p",[e._v("同时，因为此分区用于交换，我们需要修改改分区的system ID。")]),e._v(" "),n("p",[e._v("输入t后，指定分区2，然后可以输入L来显示所有的ID以供参考。我们可以看到82代表了Linux Swap。所以我们将其修改为82. 过程如下：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Command (m for help): t\nPartition number (1,2, default 2): 2\nHex code (type L to list all codes): L\n\n 0  Empty           24  NEC DOS         81  Minix / old Lin bf  Solaris\n 1  FAT12           27  Hidden NTFS Win 82  Linux swap / So c1  DRDOS/sec (FAT-\n 2  XENIX root      39  Plan 9          83  Linux           c4  DRDOS/sec (FAT-\n 3  XENIX usr       3c  PartitionMagic  84  OS/2 hidden C:  c6  DRDOS/sec (FAT-\n 4  FAT16 <32M      40  Venix 80286     85  Linux extended  c7  Syrinx\n 5  Extended        41  PPC PReP Boot   86  NTFS volume set da  Non-FS data\n 6  FAT16           42  SFS             87  NTFS volume set db  CP/M / CTOS / .\n 7  HPFS/NTFS/exFAT 4d  QNX4.x          88  Linux plaintext de  Dell Utility\n 8  AIX             4e  QNX4.x 2nd part 8e  Linux LVM       df  BootIt\n 9  AIX bootable    4f  QNX4.x 3rd part 93  Amoeba          e1  DOS access\n a  OS/2 Boot Manag 50  OnTrack DM      94  Amoeba BBT      e3  DOS R/O\n b  W95 FAT32       51  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor\n c  W95 FAT32 (LBA) 52  CP/M            a0  IBM Thinkpad hi eb  BeOS fs\n e  W95 FAT16 (LBA) 53  OnTrack DM6 Aux a5  FreeBSD         ee  GPT\n f  W95 Ext'd (LBA) 54  OnTrackDM6      a6  OpenBSD         ef  EFI (FAT-12/16/\n10  OPUS            55  EZ-Drive        a7  NeXTSTEP        f0  Linux/PA-RISC b\n11  Hidden FAT12    56  Golden Bow      a8  Darwin UFS      f1  SpeedStor\n12  Compaq diagnost 5c  Priam Edisk     a9  NetBSD          f4  SpeedStor\n14  Hidden FAT16 <3 61  SpeedStor       ab  Darwin boot     f2  DOS secondary\n16  Hidden FAT16    63  GNU HURD or Sys af  HFS / HFS+      fb  VMware VMFS\n17  Hidden HPFS/NTF 64  Novell Netware  b7  BSDI fs         fc  VMware VMKCORE\n18  AST SmartSleep  65  Novell Netware  b8  BSDI swap       fd  Linux raid auto\n1b  Hidden W95 FAT3 70  DiskSecure Mult bb  Boot Wizard hid fe  LANstep\n1c  Hidden W95 FAT3 75  PC/IX           be  Solaris boot    ff  BBT\n1e  Hidden W95 FAT1 80  Old Minix\nHex code (type L to list all codes): 82\nChanged type of partition 'Linux' to 'Linux swap / Solaris'\n")])])]),n("p",[e._v("到这里分区的删除、重新创建就已经结束了。最后一定要注意使用w命令将其写入硬盘，否则所有的修改都是无效的。")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Command (m for help): w\nThe partition table has been altered!\n\nCalling ioctl() to re-read partition table.\n\nWARNING: Re-reading the partition table failed with error 16: Device or resource busy.\nThe kernel still uses the old table. The new table will be used at\nthe next reboot or after you run partprobe(8) or kpartx(8)\nSyncing disks.\n")])])]),n("p",[e._v("最后"),n("code",[e._v("sudo reboot")]),e._v("重启机器，以应用新的分区表。")]),e._v(" "),n("p",[e._v("重启后使用"),n("code",[e._v("fdisk -l")]),e._v("命令发现，新的分区表已经生成成功。")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("[root@virt2 ~]# fdisk -l\n\nDisk /dev/vda: 214.7 GB, 214748364800 bytes, 419430400 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x000c411d\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/vda1            2048   385878015   192937984   83  Linux\n/dev/vda2       385878016   419430399    16776192   82  Linux swap / Solaris\n")])])]),n("h2",{attrs:{id:"扩大文件系统"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#扩大文件系统"}},[e._v("#")]),e._v(" 扩大文件系统")]),e._v(" "),n("p",[e._v("对硬盘重新分区后，使用"),n("code",[e._v("df -hT")]),e._v(" 查看文件系统时，发现事情没有这么简单...")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("[root@virt2 ~]# df -hT\nFilesystem     Type      Size  Used Avail Use% Mounted on\n/dev/vda1      ext4       30G  1.5G   27G   6% /\ndevtmpfs       devtmpfs   16G     0   16G   0% /dev\ntmpfs          tmpfs      16G     0   16G   0% /dev/shm\ntmpfs          tmpfs      16G  8.6M   16G   1% /run\ntmpfs          tmpfs      16G     0   16G   0% /sys/fs/cgroup\ntmpfs          tmpfs     3.2G     0  3.2G   0% /run/user/0\n")])])]),n("p",[e._v("在这里，/dev/vda1分区的容量还是只有30G. 这是因为改变的是分区大小，而其对应的文件系统不会自动改变容量，需要继续进行相关操作来扩大文件系统的容量。")]),e._v(" "),n("p",[e._v("在网上搜集相关资料后，发现一个相关命令"),n("code",[e._v("resize2fs")]),e._v(". 通过"),n("code",[e._v("man resize2fs")]),e._v("命令发现了一段关键信息：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("If you wish to enlarge a filesystem, you must make sure you can expand the  size of  the  underlying partition first. \nThis can be done using fdisk(8) by deleting the partition and recreating it with a larger size or using lvex-tend(8), \nif you're using the logical volume manager lvm(8).  \nWhen recreating the partition, make sure you create it with  the  same  starting  disk cylinder as before!\nOtherwise, the resize operation will certainly not work, and you may lose your entire filesystem. \nAfter running fdisk(8),run resize2fs to resize the ext2 filesystem to use all of the space in the newly enlarged partition.\n")])])]),n("p",[e._v("这里说的意思是：如果你想要扩大文件系统的容量，首先需要确保你可以扩大其对应的磁盘分区容量.（可以使用"),n("code",[e._v("fdisk")]),e._v("命令来删除并重新创建分区；而如果你使用lvm的话，需要使用"),n("code",[e._v("lvextend")]),e._v("命令）。\n然后，对于 "),n("code",[e._v("ext2/3/4")]),e._v(" 类型的文件系统，可以使用 "),n("code",[e._v("resize2fs")]),e._v("来改变文件系统容量。")]),e._v(" "),n("p",[e._v("所以我输入命令 "),n("code",[e._v("resize2fs /dev/vda1")]),e._v(" 成功得扩大了文件系统容量。")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("[root@virt2 ~]# resize2fs /dev/vda1\nresize2fs 1.42.9 (28-Dec-2013)\nFilesystem at /dev/vda1 is mounted on /; on-line resizing required\nold_desc_blocks = 4, new_desc_blocks = 23\nThe filesystem on /dev/vda1 is now 48234496 blocks long.\n\n")])])]),n("p",[e._v("然后用 "),n("code",[e._v("df -hT")]),e._v("来查看文件系统")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("[root@virt2 ~]# df -hT\nFilesystem     Type      Size  Used Avail Use% Mounted on\n/dev/vda1      ext4      181G  1.5G  172G   1% /\ndevtmpfs       devtmpfs   16G     0   16G   0% /dev\ntmpfs          tmpfs      16G     0   16G   0% /dev/shm\ntmpfs          tmpfs      16G  8.6M   16G   1% /run\ntmpfs          tmpfs      16G     0   16G   0% /sys/fs/cgroup\ntmpfs          tmpfs     3.2G     0  3.2G   0% /run/user/0\n")])])]),n("p",[e._v("发现已经成功扩容。")]),e._v(" "),n("p",[e._v("最后使用"),n("code",[e._v("mkswap /dev/vda2 && swapon /dev/vda2")]),e._v(" 使用swap交换。")]),e._v(" "),n("h2",{attrs:{id:"lvm-logical-volume-manager"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#lvm-logical-volume-manager"}},[e._v("#")]),e._v(" LVM (Logical Volume Manager)")]),e._v(" "),n("p",[e._v("LVM是 逻辑卷管理（Logical Volume Manager）的简写，它是 Linux 环境下对磁盘分区管理的一种机制。")]),e._v(" "),n("p",[e._v("在以上系统中，文件系统（File System）直接建立于硬盘分区（Partition）上。而这种方式下，由于硬盘分区在确定后很难更改大小，所以文件系统的大小也很难在运行时改变大小（尤其是减小）。如果在使用过程中发现文件系统容量不够，需要随机应变时，这种简单的磁盘分区管理机制就无法满足要求了。")]),e._v(" "),n("p",[e._v("因此完美地解决方法应该是在零停机前提下可以自如地对文件系统对大小进行调整，可以方便地实现文件系统跨越不同磁盘和分区。LVM机制就是这样一种方案。")]),e._v(" "),n("p",[e._v("LVM本质上是一个虚拟设备驱动，是在内核中块设备和物理设备之间添加的一个新的抽象层次，如图所示。\n"),n("img",{attrs:{src:a(426),alt:"lvm"}})]),e._v(" "),n("ul",[n("li",[e._v("PV（Physical Volume)：物理卷，处于LVM的最底层，可以是硬盘分区、整个硬盘、元设备或者回送文件(loopback file)。")]),e._v(" "),n("li",[e._v("VG（Volume Group)：卷组，建立在PV之上，可以含有一个到多个PV。")]),e._v(" "),n("li",[e._v("LV（Logical Volume）：逻辑卷，建立在VG之上，相当于原来分区的概念。优点是灵活，大小可以动态改变，并且不需要在物理上连续，甚至可以跨硬盘。")])]),e._v(" "),n("p",[e._v("使用LVM的基本步骤如下：")]),e._v(" "),n("ol",[n("li",[e._v("如果有必要的话，安装新的硬盘。")]),e._v(" "),n("li",[e._v("选做：为硬盘进行分区。")]),e._v(" "),n("li",[e._v("使用"),n("code",[e._v("pvcreate")]),e._v("命令将硬盘或者分区创建成为LVM管理的物理卷。")]),e._v(" "),n("li",[e._v("使用"),n("code",[e._v("vgcreate")]),e._v("创建新的卷组或者使用"),n("code",[e._v("vgextend")]),e._v("将PV加入现有的卷组。")]),e._v(" "),n("li",[e._v("使用"),n("code",[e._v("lvcreate")]),e._v("在VG上创建新的逻辑卷。")]),e._v(" "),n("li",[e._v("使用"),n("code",[e._v("mkfs")]),e._v("在逻辑卷上创建新的文件系统。")]),e._v(" "),n("li",[e._v("在"),n("code",[e._v("/etc/fstab")]),e._v("中写入相应条目，将文件系统 mount 在合适的目录下。")]),e._v(" "),n("li",[e._v("mount 文件系统。")])]),e._v(" "),n("h3",{attrs:{id:"举例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#举例"}},[e._v("#")]),e._v(" 举例")]),e._v(" "),n("p",[e._v("假设现在安装了一块新的硬盘"),n("code",[e._v("/dev/hdd")]),e._v("，可以通过以下操作创建新的文件系统。")]),e._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# create new PV from hard drive.")]),e._v("\npvcreate /dev/hdd\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# add PV to existing volume group")]),e._v("\nvgextend /dev/MyVG01 /dev/hdd\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# create a logical volume")]),e._v("\nlvcreate -L 50G --name Stuff MyVG01\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# create a file system")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkfs")]),e._v(" -t ext4 /dev/MyVG01/Stuff\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# add a file system label")]),e._v("\ne2label /dev/MyVG01/Stuff Stuff\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# mount the file system")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# add an apporiate entry to /etc/fstab ")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# use df, lvs, vgs to check.")]),e._v("\n")])])]),n("p",[e._v("假设想要为文件系统扩容，在为VG添加了PV后：")]),e._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# extend the logical volume")]),e._v("\nlvextend -L 50G /dev/MyVG01/Stuff\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# expand teh file system")]),e._v("\nresize2fs /dev/MyVG01/Stuff\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# check ")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("df")]),e._v(" -hT\n")])])])])}),[],!1,null,null,null);t.default=s.exports}}]);