<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>动态内存管理 | LBW&#39;s Wiki Pages</title>
    <meta name="description" content="Organize all of my knowledge.">
    <link rel="icon" href="/wiki/lbw-wiki.png">
    
    <link rel="preload" href="/wiki/assets/css/0.styles.08165e7c.css" as="style"><link rel="preload" href="/wiki/assets/js/app.c421db3b.js" as="script"><link rel="preload" href="/wiki/assets/js/2.6eab3bcd.js" as="script"><link rel="preload" href="/wiki/assets/js/4.98167148.js" as="script"><link rel="prefetch" href="/wiki/assets/js/10.101534f7.js"><link rel="prefetch" href="/wiki/assets/js/11.8dc910ab.js"><link rel="prefetch" href="/wiki/assets/js/12.538cb227.js"><link rel="prefetch" href="/wiki/assets/js/13.91bcf9c8.js"><link rel="prefetch" href="/wiki/assets/js/14.46db8181.js"><link rel="prefetch" href="/wiki/assets/js/15.6c9d9513.js"><link rel="prefetch" href="/wiki/assets/js/16.18d8290f.js"><link rel="prefetch" href="/wiki/assets/js/17.dc7ef9c0.js"><link rel="prefetch" href="/wiki/assets/js/18.8c4a6f45.js"><link rel="prefetch" href="/wiki/assets/js/19.0c65302c.js"><link rel="prefetch" href="/wiki/assets/js/20.a77d92ec.js"><link rel="prefetch" href="/wiki/assets/js/21.232b5847.js"><link rel="prefetch" href="/wiki/assets/js/22.e379164e.js"><link rel="prefetch" href="/wiki/assets/js/23.1d81ea2d.js"><link rel="prefetch" href="/wiki/assets/js/24.1ee88ec8.js"><link rel="prefetch" href="/wiki/assets/js/25.311782fd.js"><link rel="prefetch" href="/wiki/assets/js/26.2a1c9083.js"><link rel="prefetch" href="/wiki/assets/js/27.ab9ae01f.js"><link rel="prefetch" href="/wiki/assets/js/28.2c05f13f.js"><link rel="prefetch" href="/wiki/assets/js/29.0beb3286.js"><link rel="prefetch" href="/wiki/assets/js/3.1cb06f8b.js"><link rel="prefetch" href="/wiki/assets/js/30.857352b1.js"><link rel="prefetch" href="/wiki/assets/js/31.a50c5b66.js"><link rel="prefetch" href="/wiki/assets/js/32.885badda.js"><link rel="prefetch" href="/wiki/assets/js/33.ef707ccf.js"><link rel="prefetch" href="/wiki/assets/js/34.5894f25e.js"><link rel="prefetch" href="/wiki/assets/js/35.c2b91725.js"><link rel="prefetch" href="/wiki/assets/js/36.9fba88ad.js"><link rel="prefetch" href="/wiki/assets/js/37.752043da.js"><link rel="prefetch" href="/wiki/assets/js/38.882d7e50.js"><link rel="prefetch" href="/wiki/assets/js/39.3ec66f7c.js"><link rel="prefetch" href="/wiki/assets/js/40.919cf8ba.js"><link rel="prefetch" href="/wiki/assets/js/41.c6f31d63.js"><link rel="prefetch" href="/wiki/assets/js/42.cd99889d.js"><link rel="prefetch" href="/wiki/assets/js/43.9a37a0dc.js"><link rel="prefetch" href="/wiki/assets/js/44.c37374ca.js"><link rel="prefetch" href="/wiki/assets/js/45.346f5370.js"><link rel="prefetch" href="/wiki/assets/js/46.7877739c.js"><link rel="prefetch" href="/wiki/assets/js/47.3369df03.js"><link rel="prefetch" href="/wiki/assets/js/48.069b0408.js"><link rel="prefetch" href="/wiki/assets/js/49.6222591f.js"><link rel="prefetch" href="/wiki/assets/js/5.41eedec9.js"><link rel="prefetch" href="/wiki/assets/js/50.179cbb5d.js"><link rel="prefetch" href="/wiki/assets/js/51.e28d25ba.js"><link rel="prefetch" href="/wiki/assets/js/52.703b7f0e.js"><link rel="prefetch" href="/wiki/assets/js/53.22087103.js"><link rel="prefetch" href="/wiki/assets/js/54.c14c3e30.js"><link rel="prefetch" href="/wiki/assets/js/55.5d3726f9.js"><link rel="prefetch" href="/wiki/assets/js/56.e611b646.js"><link rel="prefetch" href="/wiki/assets/js/57.217ad611.js"><link rel="prefetch" href="/wiki/assets/js/58.b02579c3.js"><link rel="prefetch" href="/wiki/assets/js/59.bcedc9ab.js"><link rel="prefetch" href="/wiki/assets/js/6.3d11f12f.js"><link rel="prefetch" href="/wiki/assets/js/7.e95d627d.js"><link rel="prefetch" href="/wiki/assets/js/8.10751aae.js"><link rel="prefetch" href="/wiki/assets/js/9.e70a3818.js">
    <link rel="stylesheet" href="/wiki/assets/css/0.styles.08165e7c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wiki/" class="home-link router-link-active"><!----> <span class="site-name">LBW's Wiki Pages</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/wiki/overview/" class="nav-link">概览</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/algorithm/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/wiki/operating-system/" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/wiki/computer-network/" class="nav-link">计算机网络</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/language/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/wiki/language/c/" class="nav-link router-link-active">C/C++</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/backend/tomcat/" class="nav-link">Tomcat</a></li><li class="dropdown-item"><!----> <a href="/wiki/backend/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/wiki/backend/database/" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/microservice/" class="nav-link">微服务架构</a></li><li class="dropdown-item"><!----> <a href="/wiki/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/wiki/kubernetes/" class="nav-link">Kubernetes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/frontend/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/wiki/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/wiki/devops/" class="nav-link">Dev-Ops</a></li><li class="dropdown-item"><!----> <a href="/wiki/circumvent-internet/" class="nav-link">科学上网</a></li></ul></div></div><div class="nav-item"><a href="https://lebw.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/lebw/my-wiki" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/wiki/overview/" class="nav-link">概览</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/algorithm/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/wiki/operating-system/" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/wiki/computer-network/" class="nav-link">计算机网络</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">编程语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/language/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/wiki/language/c/" class="nav-link router-link-active">C/C++</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/backend/tomcat/" class="nav-link">Tomcat</a></li><li class="dropdown-item"><!----> <a href="/wiki/backend/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/wiki/backend/database/" class="nav-link">数据库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">微服务</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/microservice/" class="nav-link">微服务架构</a></li><li class="dropdown-item"><!----> <a href="/wiki/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/wiki/kubernetes/" class="nav-link">Kubernetes</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wiki/frontend/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/wiki/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/wiki/devops/" class="nav-link">Dev-Ops</a></li><li class="dropdown-item"><!----> <a href="/wiki/circumvent-internet/" class="nav-link">科学上网</a></li></ul></div></div><div class="nav-item"><a href="https://lebw.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/lebw/my-wiki" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/wiki/language/c/standard-library.html" class="sidebar-link">C/C++ 标准库</a></li><li><a href="/wiki/language/c/string-operation.html" class="sidebar-link">字符串操作</a></li><li><a href="/wiki/language/c/memory-operation.html" class="active sidebar-link">动态内存管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wiki/language/c/memory-operation.html#malloc与free" class="sidebar-link">malloc与free</a></li><li class="sidebar-sub-header"><a href="/wiki/language/c/memory-operation.html#new和delete" class="sidebar-link">new和delete</a></li><li class="sidebar-sub-header"><a href="/wiki/language/c/memory-operation.html#malloc-free-与-new-delete-区别和联系" class="sidebar-link">malloc/free 与 new/delete 区别和联系</a></li></ul></li><li><a href="/wiki/language/c/file-operation.html" class="sidebar-link">文件操作</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="动态内存管理"><a href="#动态内存管理" aria-hidden="true" class="header-anchor">#</a> 动态内存管理</h1> <h2 id="malloc与free"><a href="#malloc与free" aria-hidden="true" class="header-anchor">#</a> malloc与free</h2> <p>malloc与free是C语言标准库中的函数，用于动态内存分配与释放。</p> <p><code>malloc</code></p> <ul><li>C语言中的标准库函数，存在于头文件<code>&lt;stdlib.h&gt;</code>中。</li> <li>函数声明为： <code>void* malloc(size_t size)</code>。</li> <li>作用：为开辟一块<code>size</code>大小的内存空间，如果分配成功则返回指向这块空间的指针，分配失败则返回空指针NULL。</li></ul> <p><code>free</code></p> <ul><li>也是C语言中的标准库函数，存在与头文件<code>&lt;stdlib.h&gt;</code>中。</li> <li>函数声明为： <code>void free(void *ptr)</code>。</li> <li>作用：将分配给指针ptr指向区域的内存空间进行回收。</li> <li>这里的ptr必须已经被<code>malloc</code>或者<code>realloc</code>,<code>calloc</code>类型的函数调用过，否则会产生未定义行为。</li> <li>如果free(ptr)已经被调用过，重复调用也会产生未定义行为。</li> <li>如果ptr为NULL，不执行任何操作。</li></ul> <h3 id="实现原理"><a href="#实现原理" aria-hidden="true" class="header-anchor">#</a> 实现原理</h3> <p>malloc以及free可以有多种实现方式，并且没有一种方法是完美的，因为我们需要在速度，开销和避免碎片/空间有效性之间做出折衷。</p> <p>简单来说，我们把进程中一个从x到y的内存区域称为「堆」。所有<code>malloc</code>函数分配的内存会存在这个区域中。<code>malloc</code>会维护一个数据结构，我们干脆简化为一个链表，其中含有内存块的「元信息」，以及真正存放数据的「内存块区域」。当我们调用<code>malloc</code>的时候，它会遍历这个列表寻找有没有合适大小的未分配的内存块，如果有的话，将其指针返回，并且标记这块内存已经被分配了；如果没有的话，它会使用<code>sbrk()</code>这个系统调用来扩大堆区域，也就是说增加y的值（注意这里<code>sbrk</code>一定是一个系统调用，我们不可能从用户空间去改变堆的大小）。并且，这里的y是不能无限制增长的，在Linux中有一个变量<code>RLIMIT_DATA</code>用来限制进程中数据区（data segment，包括初始化数据，未初始化数据以及堆）的最大值。当堆区增长到最大限度后，再调用<code>sbrk</code>就会报<code>ENOMEM</code>错误。
<img src="/wiki/assets/img/heap-region.5f9f787a.png" alt="heap-region"> <img src="/wiki/assets/img/heap-structure.66bb6a22.png" alt="heap-structure"></p> <p>我们还要注意，在Linux实现中，当malloc申请的内存超过<code>MMAP_THRESHOLD</code>时，它就不会使用<code>sbrk</code>去增加堆大小分配内存了，而是直接使用<code>mmap</code>系统调用做一个私有匿名映射，为其分配内存。这里的<code>MMAP_THRESHOLD</code>默认为128KB，并且可以通过<code>mallopt</code>系统调用去修改其大小。这里我们没有直接堆内存，因此内存分配大小不会受到<code>RLIMIT_DATA</code>的影响。</p> <p>另一方面，<code>free(void *ptr)</code>在实现的时候，会找到ptr所对应的，之前所分配的内存块，将它标记为未分配，并且加入「未分配链表」中，同时还会进行一些空闲内存整合的操作，来减小内存碎片。</p> <h2 id="new和delete"><a href="#new和delete" aria-hidden="true" class="header-anchor">#</a> new和delete</h2> <p>在C语言中，我们写程序时，总是会有动态开辟内存的需求，每到这个时候我们就会想到用malloc/free 去从堆里面动态申请出来一段内存给我们用。但对这一块申请出来的内存，往往还需要我们对它进行稍许的“加工”后即初始化 才能为我们所用，虽然C语言为我们提供了<code>calloc</code>来开辟一段初始化好（0）的一段内存，但面对象中各是各样的数据成员初始化，它同样束手无策。同时，为了保持良好的编程习惯，我们也都应该对申请出来的内存作手动进行初始化。
对此，这常常让我们感到一丝繁琐，于是到了C++中就有了<code>new/delete, new[]/delete[]</code> ，用它们便可实现动态的内存管理。</p> <p>在C++中，把int 、char..等内置类型的变量也看作对象，它们也是存在构造函数和析构函数的，只是通常对它们，系统调用了默认的构造函数来初始化以及默认的析构（编译器优化）。所以new int、new int(3)看起来和普通的定义好像没什么区别。 但对于自定义类型的对象，此种方式在创建对象的同时，还会将对象初始化好；于是new/delete、new []/delete []方式管理内存相对于malloc/free的方式管理的优势就体现出来了，因为它们能保证对象一被创建出来便被初始化，出了作用域便被自动清理。</p> <p>new/delete 是C++中的「关键字」，需要编译器支持。他们的使用格式入下：
<img src="/wiki/assets/img/new-delete.c7f48827.png" alt="new-delete"></p> <p>new会先调用operator new函数，申请足够的内存（通常底层使用malloc实现）。然后调用类型的构造函数，初始化成员变量，最后返回自定义类型指针。delete先调用析构函数，然后调用operator delete函数释放内存（通常底层使用free实现）。</p> <p>这里提到的<code>operator new</code>, <code>operator delete</code>是C++标准库函数。而 new/delete 关键字真正的实现就是依赖于那几个函数的。在C++中我们称之为‘placement版’内存管理接口。</p> <div class="language-c++ extra-class"><pre class="language-text"><code>void* operator new (size_t size);　　
void operator delete (size_t size);

void* operator new [](size_t size);　　
void operator delete[] (size_t size);
</code></pre></div><p>所以，我们可以得出 new/delete 关键字的执行步骤大致如下：</p> <div class="language-c extra-class"><pre class="language-c"><code>new <span class="token operator">-&gt;</span> operator new <span class="token operator">-&gt;</span> malloc <span class="token operator">-&gt;</span> 构造函数  <span class="token comment">//初始化一个对象时</span>
new <span class="token operator">-&gt;</span> operator new<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> operator new <span class="token operator">-&gt;</span> malloc <span class="token operator">-&gt;</span> 构造函数 <span class="token comment">//初始化多个对象时</span>
delete <span class="token operator">-&gt;</span> 析构函数 <span class="token operator">-&gt;</span> operator delete <span class="token operator">-&gt;</span> free <span class="token comment">//删除单个对象时</span>
delete <span class="token operator">-&gt;</span> 析构函数 <span class="token operator">-&gt;</span> operator delete<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> operator delete <span class="token operator">-&gt;</span> free <span class="token comment">//删除多个对象时</span>
</code></pre></div><p>为了避免上述表示产生混乱，在此作出解释：operator new 底层是由 malloc 实现的，operator delete 底层是由 free 实现的（也不是必须，这其实取决于 C++标准库 具体是如何去实现这几个函数的），但是构造函数和析构函数并不是包含在operator函数中的，在new关键词中构造函数是在operator函数之后执行的，在delete关键字中析构函数是在operator函数之前执行的。</p> <p>另外，我们发现，由于在delete的时候我们要执行析构函数，如果是 delete[] 的话，我们要对所有对象依次执行析构函数，所以我们必须要知道「对象的数量」。但是我们发现在 delete[] 语法中只需传入指针，无需传入数量，那么它是如何知道对象的数目呢？</p> <p>这其实是因为，在使用 new[] 关键字创建对象时，编译器会首先用4个字节「保存对象数量」，然后在后移4个字节的地方才会调用 operator new[]函数，这样可以保证返回指针的「前面4个字节」存储的是对象数量，也就是说 delete[] 关键字 在删除对象的时候，只需要读取指针对象「之前的4个字节」即可得到对象数量，进行析构处理，然后再调用 operator delete[] 进行内存的释放。</p> <p>同时我们还要注意，并不是对于每一个 new[] 都会开辟这么4个字节去存储对象数量。对于没有显示定义析构函数的对象类型，例如 int, char这种，编译器就会进行优化，不额外开启内存存储对象数量，因为这些对象并不需要依次调用析构函数，所以直接无脑释放就行了。</p> <p>所以根据以上，我们必须注意：new一定要和delete配套使用，new[] 一定要和 delete[] 配套使用。</p> <h2 id="malloc-free-与-new-delete-区别和联系"><a href="#malloc-free-与-new-delete-区别和联系" aria-hidden="true" class="header-anchor">#</a> malloc/free 与 new/delete 区别和联系</h2> <ul><li>malloc/free只是动态分配内存空间/释放空间。而new/delete除了分配空间还会调用构造函数和析构函数进行初始化与清理（清理成员）。</li> <li>它们都是动态管理内存的入口。</li> <li>malloc/free是C/C++标准库的函数，new/delete是C++操作符。</li> <li>malloc/free需要手动计算类型大小且返回值为void*，new/delete可自动计算类型的大小，返回对应类型的指针。</li> <li>malloc/free管理内存失败会返回NULL，new/delete等的方式管理内存失败会抛出异常。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/wiki/language/c/string-operation.html" class="prev">
          字符串操作
        </a></span> <span class="next"><a href="/wiki/language/c/file-operation.html">
          文件操作
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/wiki/assets/js/app.c421db3b.js" defer></script><script src="/wiki/assets/js/2.6eab3bcd.js" defer></script><script src="/wiki/assets/js/4.98167148.js" defer></script>
  </body>
</html>
